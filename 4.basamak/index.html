<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4. Basamak DeÄŸerlendirme</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        MathJax = { tex: { macros: { rm: ['\\mathrm{#1}', 1] } }, loader: { load: ['[tex]/noerrors'] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>
    <style>
        :root {
            --bg-color: #fef2f2; --text-color: #7f1d1d; --card-bg: #ffffff; --card-shadow: 0 4px 16px rgba(239, 68, 68, 0.15);
            --primary-gradient: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            --secondary-bg: #fee2e2; --secondary-text: #b91c1c;
            --header-color: #dc2626;
            --border-color: #fca5a5;
            --evaluation-card-bg: rgba(255, 255, 255, 0.7);
            --grid-color: rgba(239, 68, 68, 0.1);
        }
        .dark-mode {
            --bg-color: #1c0b0b; --text-color: #fecaca; --card-bg: #2c1d1d; --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --secondary-bg: #451a1a; --secondary-text: #f87171;
            --header-color: #fca5a5;
            --border-color: #991b1b;
            --evaluation-card-bg: rgba(0, 0, 0, 0.2);
            --grid-color: rgba(248, 113, 113, 0.1);
        }
    * { box-sizing: border-box; margin: 0; padding: 0; font-style: normal !important; }
    body, input, textarea, button { font-family: 'Poppins', sans-serif; }
        /* MathJax: tÃ¼m matematik ifadelerini dik (non-italic) yap */
        mjx-container, mjx-container * { font-style: normal !important; }
        /* CHTML Ã§Ä±ktÄ±sÄ±ndaki tÃ¼m MathJax dÃ¼ÄŸÃ¼mleri iÃ§in fontu da dÃ¼z aileye Ã§ekiyoruz */
        mjx-container[jax="CHTML"], mjx-container[jax="CHTML"] * {
            font-style: normal !important;
            font-weight: normal !important;
            font-family: 'Poppins', Arial, sans-serif !important;
        }
        .mjx-chtml, .mjx-chtml * {
            font-style: normal !important;
            font-weight: normal !important;
            font-family: 'Poppins', Arial, sans-serif !important;
        }
        /* MathJax class adlarÄ±nÄ±n gerÃ§ek halleri (MJX-TEX-I / MJX-TEX-BI) ve inline italic stillerini de zorla kapat */
        .mjx-chtml .MJX-TEX-I, .mjx-chtml .MJX-TEX-BI, .mjx-chtml .TEX-I, .mjx-chtml .TEX-BI, .mjx-chtml .mjx-i, .mjx-chtml mjx-mi {
            font-style: normal !important;
            font-weight: normal !important;
            font-family: 'Poppins', Arial, sans-serif !important;
        }
        /* Inline style ile gelen italic'leri de kapat */
        .mjx-chtml [style*="font-style:italic"], .mjx-chtml [style*="font-style: italic"] { font-style: normal !important; }
        /* Temel MathJax elementleri */
        mjx-mi, mjx-mo, mjx-mn, mjx-mtext { font-style: normal !important; }
    /* HTML italik etiketleri de devre dÄ±ÅŸÄ± */
    em, i { font-style: normal !important; }
        body { background: var(--bg-color); color: var(--text-color); min-height: 100vh; transition: background-color 0.3s, color 0.3s; line-height: 1.6; }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .header { background: var(--card-bg); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: var(--card-shadow); position: relative; }
        #theme-toggle { position: absolute; top: 15px; right: 15px; background: var(--secondary-bg); color: var(--secondary-text); border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .page { display: none; background: var(--card-bg); border-radius: 15px; padding: 30px; box-shadow: var(--card-shadow); animation: slideIn 0.5s ease; }
        .page.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2, h3, h4, h5 { margin-bottom: 15px; color: var(--header-color); font-weight: 600; }
        h1 { font-size: 2rem; } h2 { font-size: 1.7rem; } h3 { font-size: 1.4rem; }
        .button { background: var(--primary-gradient); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; margin: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .button.secondary { background: var(--secondary-bg); color: var(--secondary-text); text-shadow: none; }
        .button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .simulation-container { display: grid; grid-template-columns: 350px 1fr; gap: 25px; align-items: start; }
        .problem-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; align-items: start; }
        .problem-context .context-image { width: 100%; border-radius: 10px; margin-bottom: 20px; box-shadow: var(--card-shadow); }
        #sim-canvas { border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-color); width: 100%; height: auto; }
        .controls { background: var(--secondary-bg); padding: 20px; border-radius: 8px; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--secondary-text); }
        .control-group .value-display { font-weight: bold; color: var(--header-color); }
        .info-box { padding: 15px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; margin-top: 10px; }
        .formula-box { background: var(--secondary-bg); padding: 15px; border-radius: 8px; margin-top: 15px; }
        .formula-box code { font-family: 'Courier New', Courier, monospace; font-size: 1.1rem; color: var(--secondary-text); display: block; word-wrap: break-word; }
        .question-group {
            margin-bottom: 20px;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 12px;
        }
        .question-group > label { font-weight: bold; display: block; margin-bottom: 8px; line-height: 1.5; }
        .question-group input, .question-group textarea { width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-color); color: var(--text-color); font-size: 1rem; }
        .question-group input:disabled, .question-group textarea:disabled { opacity: 0.7; cursor: not-allowed; }
        .input-row { display: flex; gap: 20px; }
        .coeff-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .point-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: var(--card-bg); color: var(--secondary-text); border: 1px solid var(--border-color); font-size: 0.85rem; font-weight: 700; }
        .evaluation-card { background: var(--evaluation-card-bg); border-left: 5px solid; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .warning-note { background: var(--secondary-bg); border-left: 5px solid var(--header-color); padding: 15px 20px; margin-top: 25px; border-radius: 8px; font-size: 0.9em; text-align: left; }
        .warning-note h3 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .warning-note p { margin: 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 25px; border-radius: 15px; max-width: 700px; width: 90%; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .answer-block { background: var(--secondary-bg); padding: 20px; border-radius: 8px; margin-bottom: 15px; text-align: left; }
        .answer-block h4 { color: var(--secondary-text); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-bottom: 12px; }
        .answer-block p { word-wrap: break-word; }

        @media (max-width: 900px) {
            .simulation-container, .problem-container { grid-template-columns: 1fr; }
            .page { padding: 20px; }
            h1 { font-size: 1.8rem; } h2 { font-size: 1.5rem; }
            .input-row { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button id="theme-toggle" title="TemayÄ± DeÄŸiÅŸtir">â˜€ï¸</button>
            <h1 style="margin-bottom:0.3em;">4. Basamak DeÄŸerlendirme</h1>
            <h2 style="margin-top:0; font-size:1.5rem;">GerÃ§ek SayÄ±larda TanÄ±mlÄ± Karesel Fonksiyonlar</h2>
        </div>

        <div class="page active" id="page-intro">
             <div style="text-align: center;">
                <div style="max-width: 700px; margin: 20px auto 0; background: var(--secondary-bg); border-radius: 18px; box-shadow: var(--card-shadow); padding: 32px 28px 28px 28px; color: var(--secondary-text);">
                    <h2 style="color: var(--header-color); font-size:2rem; margin-bottom:18px;">Bilgilendirme</h2>
                    <ul style="list-style-type: none; padding-left: 0; font-size:1.08em; text-align:left; margin-bottom:28px; color: var(--text-color);">
                        <li style="margin-bottom:12px;">Bu deÄŸerlendirme, gerÃ§ek sayÄ±larda tanÄ±mlÄ± karesel fonksiyonlar ve nitel Ã¶zellikleri konusundaki modelleme ve analiz becerilerinizi Ã¶lÃ§mek amacÄ±yla hazÄ±rlanmÄ±ÅŸtÄ±r.</li>
                        <li style="margin-bottom:12px;"><strong>Uygulama AkÄ±ÅŸÄ±:</strong> Ana bÃ¶lÃ¼m bir probleme dayalÄ± sÄ±navdÄ±r. Ancak, konuyu daha iyi anlamak iÃ§in hazÄ±rlanan kavram ve simÃ¼lasyon sayfalarÄ±nÄ± dilediÄŸiniz zaman inceleyebilirsiniz.</li>
                        <li style="margin-bottom:12px;"><strong>Puanlama (Toplam 25 Puan):</strong> SÄ±navdaki adÄ±mlarÄ±n puan deÄŸerleri yanlarÄ±nda belirtilmiÅŸtir. CevaplarÄ±nÄ±z yapay zeka tarafÄ±ndan deÄŸerlendirilecektir.</li>
                        <li style="color: var(--header-color); font-weight: bold; margin-top:20px;">LÃ¼tfen dikkat: SÄ±navÄ± bitirdikten sonra puanÄ±nÄ±z sisteme gÃ¶nderilecektir.</li>
                    </ul>

                    <div class="info-box" style="text-align: left; background: var(--bg-color); margin-bottom: 25px;">
                        <h4 style="color: var(--header-color);">Ä°pucu: Kavram ve SimÃ¼lasyon SayfalarÄ±</h4>
                        <p style="font-size: 0.95em; color: var(--text-color);">SÄ±nav sorularÄ±nÄ± daha etkili Ã§Ã¶zmek ve karesel fonksiyonlarÄ±n <strong>gelir ve fiyatlandÄ±rma gibi gerÃ§ek hayat problemlerinde</strong> nasÄ±l kullanÄ±ldÄ±ÄŸÄ±nÄ± daha derinlemesine anlamak iÃ§in, aÅŸaÄŸÄ±daki "Gelir Modellemesi" ve "Ä°nteraktif SimÃ¼lasyon" bÃ¶lÃ¼mlerini incelemeniz Ã¶nerilir. Bu kaynaklar, problemi modellemenize ve doÄŸru Ã§Ã¶zÃ¼me ulaÅŸmanÄ±za yardÄ±mcÄ± olacaktÄ±r.</p>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="button secondary" onclick="showPage('page-concept')">Gelir Modellemesini Ä°ncele</button>
                            <button class="button secondary" onclick="showPage('page-simulation')">SimÃ¼lasyonu KeÅŸfet</button>
                        </div>
                    </div>

                    <button class="button" onclick="beginExam()" style="border-radius:24px; padding:12px 38px; font-size:1.15rem; margin-top: 10px;">DeÄŸerlendirmeye BaÅŸla</button>
                </div>
            </div>
        </div>

        <div class="page" id="page-exam">
            <h2>SÄ±nav: Tiyatro Problemi (25 Puan)</h2>
            <div class="info-box" style="margin-bottom: 20px; text-align: center;">
                <p>YardÄ±ma mÄ± ihtiyacÄ±nÄ±z var? Konu anlatÄ±mÄ± iÃ§in <strong>Kavram SayfasÄ±na</strong> veya interaktif bir Ã¶rnek iÃ§in <strong>SimÃ¼lasyona</strong> gÃ¶z atabilirsiniz.</p>
            </div>
            <div class="problem-container">
                <div class="problem-context">
                    <img src="resim.PNG" alt="BoÅŸ bir tiyatro sahnesi ve koltuklar" class="context-image">
                    <h4>Problem Durumu</h4>
                    <p>Bir tiyatro salonunda bir biletin fiyatÄ± <strong>80 TL</strong> olarak belirlendiÄŸinde oyunu <strong>300 kiÅŸi</strong> izlemektedir. Bilet fiyatÄ±nda yapÄ±lan her <strong>10 TL</strong>'lik artÄ±ÅŸÄ±n izleyici sayÄ±sÄ±nÄ± <strong>20 kiÅŸi</strong> azalttÄ±ÄŸÄ± gÃ¶zlemlenmiÅŸtir.</p>
                    <p>Bu bilgilere gÃ¶re, geliri en Ã¼st dÃ¼zeye Ã§Ä±karmak iÃ§in <strong>Sorular</strong> bÃ¶lÃ¼mÃ¼ndeki sorularÄ± yanÄ±tlayÄ±nÄ±z. DeÄŸiÅŸken olarak, bilet fiyatÄ±nda yapÄ±lan artÄ±ÅŸ sayÄ±sÄ± 'x' alÄ±nacaktÄ±r.</p>
                </div>
                <div class="problem-questions">
                    <h3>SORULAR</h3>
                    <div class="question-group">
                        <label><strong>Soru 1 <span class="point-badge">5 Puan</span>:</strong> Problem durumuna gÃ¶re, bilet fiyatÄ±ndaki artÄ±ÅŸ sayÄ±sÄ±na (x) baÄŸlÄ± olarak Bilet FiyatÄ±nÄ± F(x) ve Ä°zleyici SayÄ±sÄ±nÄ± S(x) modelleyen fonksiyonlarÄ± yazÄ±nÄ±z.</label>
                        <div class="input-row">
                            <div style="flex:1; display:flex; gap:8px; align-items:center;">
                                <input type="text" id="p2_q1_price" placeholder="Fiyat F(x) = ?" style="flex:1;">
                                <span class="point-badge" title="Bu alanÄ±n puanÄ±">3 p</span>
                            </div>
                            <div style="flex:1; display:flex; gap:8px; align-items:center;">
                                <input type="text" id="p2_q1_sales" placeholder="Ä°zleyici S(x) = ?" style="flex:1;">
                                <span class="point-badge" title="Bu alanÄ±n puanÄ±">2 p</span>
                            </div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label><strong>Soru 2 <span class="point-badge">5 Puan</span>:</strong> Soru 1'de oluÅŸturduÄŸunuz fonksiyonlardan yararlanarak, toplam geliri ifade eden G(x) fonksiyonunu  `axÂ² + bx + c` biÃ§iminde ifade ediniz.</label>
                        <div class="coeff-row">
                            <span>G(x) =</span>
                            <div style="display:inline-flex; align-items:center; gap:6px;">
                                <input type="text" id="p2_q2_a" style="width: 80px;" placeholder="a">
                                <span class="point-badge" title="Bu alanÄ±n puanÄ±">2 p</span>
                            </div>
                            <span> xÂ² + </span>
                            <div style="display:inline-flex; align-items:center; gap:6px;">
                                <input type="text" id="p2_q2_b" style="width: 80px;" placeholder="b">
                                <span class="point-badge" title="Bu alanÄ±n puanÄ±">2 p</span>
                            </div>
                            <span> x + </span>
                            <div style="display:inline-flex; align-items:center; gap:6px;">
                                <input type="text" id="p2_q2_c" style="width: 100px;" placeholder="c">
                                <span class="point-badge" title="Bu alanÄ±n puanÄ±">1 p</span>
                            </div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label><strong>Soru 3 <span class="point-badge">5 Puan</span>:</strong> Soru 2'de elde ettiÄŸiniz G(x) gelir fonksiyonunun maksimum deÄŸerini almasÄ±nÄ± saÄŸlayan 'x' deÄŸiÅŸkeninin deÄŸerini hesaplayÄ±nÄ±z.</label>
                        <input type="text" id="p2_q3_x" style="width: 120px;" placeholder="x deÄŸeri">
                    </div>
                    <div class="question-group">
                        <label><strong>Soru 4 <span class="point-badge">5 Puan</span>:</strong> Soru 3'te bulduÄŸunuz 'x' deÄŸerini kullanarak, en yÃ¼ksek geliri saÄŸlayacak olan bilet fiyatÄ±nÄ± hesaplayÄ±nÄ±z.</label>
                        <input type="text" id="p2_q4_price" placeholder="Bilet FiyatÄ± (TL)">
                    </div>
                    <div class="question-group">
                        <label><strong>Soru 5 <span class="point-badge">5 Puan</span>:</strong> BulduÄŸunuz deÄŸerleri kullanarak tiyatronun elde edeceÄŸi maksimum geliri hesaplayÄ±nÄ±z.</label>
                        <input type="text" id="p2_q5_revenue" placeholder="Maksimum Gelir (TL)">
                    </div>
                </div>
            </div>
             <div style="text-align: center; margin-top: 30px;">
                <button class="button secondary" onclick="showPage('page-concept')">Kavram SayfasÄ±na DÃ¶n</button>
                <button class="button secondary" onclick="showPage('page-simulation')">SimÃ¼lasyona Geri DÃ¶n</button>
                <button class="button" id="finish-exam-btn" onclick="checkAndFinish()">SÄ±navÄ± Bitir ve DeÄŸerlendir</button>
            </div>
        </div>
        
        <div class="page" id="page-concept">
            <h2 style="text-align: center;">Gelir Modellemesi</h2>
            <p>Ekonomide en temel hedeflerden biri, kÃ¢rÄ± veya geliri en Ã¼st dÃ¼zeye Ã§Ä±karmaktÄ±r. Bir Ã¼rÃ¼nÃ¼n fiyatÄ±nÄ± belirlerken hassas bir denge kurulmalÄ±dÄ±r: Fiyat Ã§ok yÃ¼ksek olursa mÃ¼ÅŸteri sayÄ±sÄ± dÃ¼ÅŸer, Ã§ok dÃ¼ÅŸÃ¼k olursa birim kÃ¢r azalÄ±r. En uygun fiyat nerede gizlidir?</p>
            <p>Bu "en uygun" noktayÄ± bulma problemi, genellikle karesel fonksiyonlar kullanÄ±larak modellenir. Gelir, basitÃ§e <strong>Fiyat Ã— SatÄ±ÅŸ MiktarÄ±</strong> olarak hesaplanÄ±r. Fiyat ile satÄ±ÅŸ miktarÄ± arasÄ±ndaki ters iliÅŸki (biri artarken diÄŸeri azalÄ±r), bu iki doÄŸrusal fonksiyonun Ã§arpÄ±mÄ±nÄ±n bize kollarÄ± aÅŸaÄŸÄ±ya bakan bir parabol vermesine neden olur.</p>
            <img src="gorsel.PNG" alt="Karesel fonksiyonun maksimum noktasÄ± gelir maksimizasyonunu gÃ¶sterir" style="width: 100%; max-width: 600px; margin: 15px auto 25px; display: block; border-radius: 10px;">
            <p>Bu parabolÃ¼n <strong>maksimum noktasÄ±</strong>, gelirin en yÃ¼ksek olduÄŸu sihirli noktadÄ±r. Bu aktivitede, Ã¶nce bu iliÅŸkiyi dinamik bir simÃ¼lasyonla keÅŸfedecek, ardÄ±ndan bu keÅŸiflerinizle farklÄ± bir problemi adÄ±m adÄ±m Ã§Ã¶zeceksiniz.</p>
            <div style="text-align: center; margin-top: 30px;">
                <button class="button secondary" onclick="showPage('page-exam')">SÄ±nava Geri DÃ¶n</button>
                <button class="button" onclick="showPage('page-simulation')">SimÃ¼lasyonu KeÅŸfet</button>
            </div>
        </div>

        <div class="page" id="page-simulation">
            <h2>Ä°nteraktif SimÃ¼lasyon: Gurme Pide Salonu Senaryosu</h2>
            <!-- DEÄÄ°ÅÄ°KLÄ°K: Senaryo metni yeni deÄŸerlere gÃ¶re gÃ¼ncellendi. -->
            <p>Bu simÃ¼lasyonda baÅŸlangÄ±Ã§ durumu ÅŸÃ¶yle: Birim fiyatÄ± <strong>200 TL</strong> olan ve ortalama <strong>500 adet</strong> satÄ±ÅŸ yapan bir pide salonu, daha kaliteli malzemeler kullanarak 'gurme pide' konseptine geÃ§iyor ve gelirini artÄ±rmak iÃ§in farklÄ± fiyatlandÄ±rma stratejileri deniyor. AÅŸaÄŸÄ±daki kontrol panelinden fiyat artÄ±ÅŸ miktarÄ±nÄ± ve buna tepki olarak satÄ±ÅŸtaki azalÄ±ÅŸÄ± deÄŸiÅŸtirerek, <strong>fiyatâ€“satÄ±ÅŸ iliÅŸkisine</strong> baÄŸlÄ± gelirin <em>(G(x) = F(x) â€¢ S(x))</em> nasÄ±l deÄŸiÅŸtiÄŸini anlÄ±k olarak gÃ¶zlemleyin.</p>
            <div class="simulation-container">
                <div class="controls">
                    <h4>Senaryo DeÄŸiÅŸkenleri</h4>
                    <div class="control-group">
                        <label for="discount-slider">Fiyat ArtÄ±ÅŸ MiktarÄ± (TL)</label>
                        <input type="range" id="discount-slider" min="1" max="20" value="14" step="1" style="width: 100%;">
                        <div class="value-display">Her adÄ±mda <span id="discount-display">14</span> TL fiyat artÄ±ÅŸÄ±</div>
                    </div>
                    <div class="control-group">
                        <label for="sales-increase-slider">Azalan SatÄ±ÅŸ Adedi</label>
                        <input type="range" id="sales-increase-slider" min="5" max="50" value="10" step="5" style="width: 100%;">
                        <div class="value-display">Her artÄ±ÅŸta <span id="sales-increase-display">10</span> adet satÄ±ÅŸ azalÄ±ÅŸÄ±</div>
                    </div>
                    <hr style="border-color: var(--border-color); margin: 20px 0;">
                    <h4>Fonksiyon TanÄ±mlarÄ±</h4>
                    <div class="formula-box" style="text-align: left; padding: 10px;">
                        <code><strong>Fiyat Fonksiyonu</strong><br>F(x) = <span id="formula-fx">200 + 14x</span></code>
                        <code style="margin-top: 10px;"><strong>SatÄ±ÅŸ Fonksiyonu</strong><br>S(x) = <span id="formula-sx">500 - 10x</span></code>
                    </div>
                    <h4>Gelir Fonksiyonu ve Maksimum NoktasÄ±</h4>
                    <div class="formula-box" style="text-align: left; padding: 10px;">
                        <code><strong>Gelir G(x) = F(x) â€¢ S(x)</strong><br><span id="formula-gx-standard">G(x) = -140xÂ² + 5000x + 100000</span></code>
                        <code style="margin-top: 10px;"><strong>Tam Kare Formu </strong><br><span id="formula-gx-vertex">G(x) = -140(x - 17,86)Â² + 144642,86</span></code>
                    </div>
                </div>
                <div>
                    <canvas id="sim-canvas"></canvas>
                     <div class="info-box" style="text-align: center;">
                        <!-- DEÄÄ°ÅÄ°KLÄ°K: BaÅŸlangÄ±Ã§ deÄŸerleri yeni senaryoya gÃ¶re gÃ¼ncellendi. -->
                        <p><strong>Fiyat ArtÄ±ÅŸ SayÄ±sÄ± (x):</strong> <span id="x-display">0</span> | <strong>Fiyat:</strong> <span id="price-display">200</span> TL | <strong>SatÄ±ÅŸ:</strong> <span id="sales-display">500</span> | <strong>Gelir:</strong> <span id="revenue-display">100000</span> TL</p>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <label for="x-slider">Fiyat ArtÄ±ÅŸ SayÄ±sÄ±nÄ± DeÄŸiÅŸtirerek GrafiÄŸi KeÅŸfet</label>
                        <!-- DEÄÄ°ÅÄ°KLÄ°K: Slider'Ä±n max deÄŸeri yeni tepe noktasÄ±na gÃ¶re ayarlandÄ±. -->
                        <input type="range" id="x-slider" min="0" max="25" value="0" step="0.5" style="width: 100%;">
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="button" onclick="showPage('page-exam')">AnladÄ±m, SÄ±nava GeÃ§</button>
            </div>
        </div>
        
        <div class="page" id="page-evaluation">
             <h2 style="text-align:center;">DeÄŸerlendirme SonuÃ§larÄ±</h2>
            <p id="evaluation-subtitle" style="text-align:center; margin-top:-10px; margin-bottom:20px; color:var(--secondary-text);">YanÄ±tlarÄ±nÄ±z yapay zeka tarafÄ±ndan analiz ediliyor.</p>
            <div id="scoreCard" style="padding: 20px; border-radius: 12px; text-align: center; margin: 20px 0; color: white;">
                <div style="font-size: 1rem; opacity: 0.8;">TOPLAM PUAN</div>
                <div id="finalScore" style="font-size: 3rem; font-weight: 700;">-- / 25</div>
                <div id="finalPercentage" style="font-size: 1.2rem; font-weight: 600;">--%</div>
            </div>
            <div id="evaluationContent">
                <div style="text-align: center; padding: 40px 0;"><div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: var(--header-color);"></div><h4 style="margin-top: 20px;">DeÄŸerlendirme SÃ¼rÃ¼yor...</h4></div>
            </div>
            <div style="text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button class="button secondary" onclick="showPage('page-exam')">â† SÄ±nava DÃ¶n</button>
                <button id="viewSolutionsBtn" class="button" onclick="openSolutionsModal()" style="display:none;">Ã‡Ã¶zÃ¼mleri GÃ¶r</button>
            </div>
             <div class="warning-note">
                <h3>âš ï¸ YZ Destekli DeÄŸerlendirme HakkÄ±nda</h3>
                <p>Bu etkinlikte verilen otomatik deÄŸerlendirmeler ve geri bildirimler yapay zeka tarafÄ±ndan saÄŸlanmaktadÄ±r. AmaÃ§, Ã¶ÄŸrenmenize destek olmak ve farklÄ± Ã§Ã¶zÃ¼m yollarÄ±nÄ± gÃ¶stermektir. YZ Ã§Ä±ktÄ±larÄ± bir uzman gÃ¶rÃ¼ÅŸÃ¼nÃ¼n yerine geÃ§mez ve nadiren hatalar iÃ§erebilir. KararsÄ±z kaldÄ±ÄŸÄ±nÄ±z noktalarda Ã¶ÄŸretmeninizden teyit alÄ±nÄ±z.</p>
            </div>
        </div>
    </div>

    <!-- Solution Modal -->
    <div id="solution-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeSolutionsModal()">&times;</span><h2 style="text-align:center;">DetaylÄ± Ã‡Ã¶zÃ¼mler</h2><div id="solutionContent"></div></div></div>
    
    <!-- Ses dosyasÄ± isteÄŸe baÄŸlÄ±, dosya yoksa yÃ¼klemeyi denemeyelim -->
    <audio id="clickSound" src="click.mp3" preload="none"></audio>

<script>
    // DEÄÄ°ÅÄ°KLÄ°K: BaÅŸlangÄ±Ã§ta sÃ¼rgÃ¼ler 14 (fiyat artÄ±ÅŸÄ±) ve 10 (azalan satÄ±ÅŸ) olsun
    const simParams = { basePrice: 200, baseSales: 500, priceIncrease: 14, salesDecrease: 10 };
    
    // SÄ±nav gÃ¶nderim durumu (kalÄ±cÄ±)
    let examSubmitted = false;
    
    document.addEventListener('DOMContentLoaded', () => {
        setupThemeToggle();
        showPage('page-intro');
        // Sayfa yÃ¼klendiÄŸinde sÄ±navÄ±n gÃ¶nderim durumunu yÃ¼kle
        try { examSubmitted = (localStorage.getItem('examSubmitted') === 'true'); } catch {}
        
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', playClickSound);
        });
    });

    function playClickSound() {
        try {
            const sound = document.getElementById('clickSound');
            if (sound && sound.src && sound.src.length > 0) { sound.currentTime = 0; sound.play().catch(e => {}); }
        } catch (e) { console.error("Ses dosyasÄ± hatasÄ±:", e); }
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'page-simulation') {
            initializeSimulation();
        } else if (pageId === 'page-exam') {
            // SÄ±nav sayfasÄ±na gelindiÄŸinde duruma gÃ¶re alan ve butonlarÄ± ayarla
            const finishBtn = document.getElementById('finish-exam-btn');
            const fields = document.querySelectorAll('#page-exam input, #page-exam textarea');
            if (examSubmitted) {
                if (finishBtn) { finishBtn.textContent = 'SonuÃ§larÄ± GÃ¶r'; finishBtn.disabled = false; }
                fields.forEach(field => field.disabled = true);
            } else {
                if (finishBtn) { finishBtn.textContent = 'SÄ±navÄ± Bitir ve DeÄŸerlendir'; finishBtn.disabled = false; }
                fields.forEach(field => field.disabled = false);
            }
        }
    }

    // Ã–ÄŸrenci yeni bir denemeye buradan baÅŸlar; kilit kaldÄ±rÄ±lÄ±r ve sÄ±nav aÃ§Ä±lÄ±r
    function beginExam() {
        resetExam(true);
        showPage('page-exam');
    }

    function setupThemeToggle() {
        const toggle = document.getElementById('theme-toggle');
        const isDarkMode = localStorage.getItem('theme') === 'dark';
        if (isDarkMode) { document.body.classList.add('dark-mode'); toggle.textContent = 'ğŸŒ™'; }
        toggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            toggle.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', theme);
            if (document.getElementById('page-simulation').classList.contains('active')) {
                updateSimulation();
            }
        });
    }

    // --- HELPER FUNCTIONS ---
    function formatNumber(num) {
        if (isNaN(num)) return num;
        let formattedNum = parseFloat(num.toFixed(2));
        return formattedNum.toString().replace('.', ',');
    }
    function localizeDecimalDots(text){
        try {
            if (!text || typeof text !== 'string') return text;
            return text.replace(/(\d+)\.(\d+)/g, '$1,$2');
        } catch { return text; }
    }

    // LMS'e puan gÃ¶nderme
    function sendScoreToLMS(ogrenciPuani) {
        try {
            const rounded = Math.round(ogrenciPuani || 0);
            const result = {
                score: { max: 25, min: 0, raw: rounded, scaled: rounded / 25 },
                completion: true,
                success: true,
                duration: "PT4.95S"
            };
            const lmsWindow = window.parent?.document?.getElementById("frmApp-0")?.contentWindow;
            if (lmsWindow?.onCompleted) {
                console.log("ğŸ“¡ LMS'e veri gÃ¶nderiyorum...");
                lmsWindow.onCompleted(result);
            } else {
                console.error("âŒ LMS'ye sinyal gÃ¶nderilemedi!");
            }
        } catch (error) {
            console.error("LMS'e puan gÃ¶nderilirken hata oluÅŸtu:", error);
        }
    }

    // SÄ±navÄ± sÄ±fÄ±rla: kilidi kaldÄ±r, istenirse alanlarÄ± temizle
    function resetExam(clearFields = false) {
        try { localStorage.removeItem('examSubmitted'); } catch {}
        examSubmitted = false;
        const fields = document.querySelectorAll('#page-exam input, #page-exam textarea');
        if (fields && fields.length) {
            fields.forEach(field => {
                field.disabled = false;
                if (clearFields) field.value = '';
            });
        }
        const finishBtn = document.getElementById('finish-exam-btn');
        if (finishBtn) { finishBtn.textContent = 'SÄ±navÄ± Bitir ve DeÄŸerlendir'; finishBtn.disabled = false; }
    }
    
    // --- SIMULATION (Gurme Pide Salonu - GÃœNCELLENDÄ°) ---
    function initializeSimulation() {
        ['discount-slider', 'sales-increase-slider', 'x-slider'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateSimulation);
        });
        const canvas = document.getElementById('sim-canvas');
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = Math.max(400, container.clientWidth * 0.7);
        // VarsayÄ±lan slider deÄŸerlerini ayarla
        document.getElementById('discount-slider').value = simParams.priceIncrease;
        document.getElementById('sales-increase-slider').value = simParams.salesDecrease;
        // x iÃ§in tanÄ±m aralÄ±ÄŸÄ±nÄ± (S(x) >= 0) temel al: x in [0, baseSales/salesDecrease]
        const xSlider = document.getElementById('x-slider');
        if (xSlider) {
            const xMaxDomain = simParams.baseSales / simParams.salesDecrease;
            xSlider.min = 0;
            xSlider.step = 0.5;
            xSlider.max = String(Number(xMaxDomain.toFixed(1)));
            // GeÃ§erli deÄŸer Ã¼st sÄ±nÄ±rÄ± aÅŸÄ±yorsa kÄ±rp
            const current = parseFloat(xSlider.value);
            if (!isFinite(current) || current > xMaxDomain) xSlider.value = String(Number(xMaxDomain.toFixed(1)));
            if (current < 0) xSlider.value = '0';
        }
        updateSimulation();
    }

    function updateSimulation() {
        simParams.priceIncrease = parseInt(document.getElementById('discount-slider').value);
        simParams.salesDecrease = parseInt(document.getElementById('sales-increase-slider').value);
        const xSlider = document.getElementById('x-slider');
        // SatÄ±ÅŸÄ±n negatif olmayacaÄŸÄ± x Ã¼st sÄ±nÄ±rÄ±nÄ± her gÃ¼ncellemede yeniden hesapla
        const step = parseFloat(xSlider.step) || 0.5;
        let xMaxDomain = simParams.baseSales / simParams.salesDecrease; // S(x) >= 0
        if (isFinite(step) && step > 0) {
            xMaxDomain = Math.floor(xMaxDomain / step) * step; // adÄ±ma uygun yuvarla
        }
        xSlider.max = String(Number(xMaxDomain.toFixed(2)));
        let x = parseFloat(xSlider.value);
        if (!isFinite(x)) x = 0;
        if (x < 0) { x = 0; }
        if (x > xMaxDomain) { x = xMaxDomain; }
        xSlider.value = String(x);
        
        document.getElementById('discount-display').textContent = simParams.priceIncrease;
        document.getElementById('sales-increase-display').textContent = simParams.salesDecrease;
        document.getElementById('x-display').textContent = formatNumber(x);

    const currentPrice = simParams.basePrice + simParams.priceIncrease * x;
    const currentSales = Math.max(simParams.baseSales - simParams.salesDecrease * x, 0);
        const currentRevenue = currentPrice * currentSales;

        document.getElementById('price-display').textContent = formatNumber(currentPrice);
        document.getElementById('sales-display').textContent = formatNumber(currentSales);
        document.getElementById('revenue-display').textContent = formatNumber(currentRevenue);
        
        const { a, b, c } = getSimRevenueFunction(simParams);
        const vertexX = -b / (2 * a);
        const vertexY = a * vertexX * vertexX + b * vertexX + c;

        document.getElementById('formula-fx').textContent = `${simParams.basePrice} + ${simParams.priceIncrease}x`;
        document.getElementById('formula-sx').textContent = `${simParams.baseSales} - ${simParams.salesDecrease}x`;
        document.getElementById('formula-gx-standard').textContent = `G(x) = ${a}xÂ² ${b >= 0 ? '+' : ''} ${b}x ${c >= 0 ? '+' : ''} ${c}`;
        document.getElementById('formula-gx-vertex').textContent = `G(x) = ${a}(x - ${formatNumber(vertexX)})Â² + ${formatNumber(vertexY)}`;
        
        drawSimulationGraph(x);
    }

    function getSimRevenueFunction(params) {
        // G(x) = (basePrice + priceIncrease*x) * (baseSales - salesDecrease*x)
        const a = -params.priceIncrease * params.salesDecrease;
        const b = params.baseSales * params.priceIncrease - params.basePrice * params.salesDecrease;
        const c = params.basePrice * params.baseSales;
        return { a, b, c, G: (x) => a * x * x + b * x + c };
    }

    function drawSimulationGraph(currentX) {
        const canvas = document.getElementById('sim-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width, h = canvas.height, padding = 60;
        
        const { a, b, G } = getSimRevenueFunction(simParams);
        const vertexX = -b / (2 * a);
        const vertexY = G(vertexX);

    const xMax = parseFloat(document.getElementById('x-slider').max); // TanÄ±m aralÄ±ÄŸÄ± Ã¼st sÄ±nÄ±rÄ±
        const yMax = vertexY > 0 ? vertexY * 1.15 : 100000;

        ctx.clearRect(0, 0, w, h);
        const textColor = getComputedStyle(document.body).getPropertyValue('--text-color');
        const gridColor = getComputedStyle(document.body).getPropertyValue('--grid-color');
        const headerColor = getComputedStyle(document.body).getPropertyValue('--header-color');
        
        const toX = val => padding + (val / xMax) * (w - 2 * padding);
        const toY = val => (h - padding) - (val / yMax) * (h - 2 * padding);
        
        const drawArrow = (x, y, angle) => { ctx.save(); ctx.translate(x, y); ctx.rotate(angle); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-10, 5); ctx.lineTo(-10, -5); ctx.closePath(); ctx.fill(); ctx.restore(); };

        ctx.strokeStyle = gridColor; ctx.lineWidth = 1;
        for (let i = 1; i <= 5; i++) {
            let y = h - padding - i * (h - 2 * padding) / 5;
            ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(w - padding, y); ctx.stroke();
            let x = padding + i * (w - 2 * padding) / 5;
            ctx.beginPath(); ctx.moveTo(x, padding); ctx.lineTo(x, h - padding); ctx.stroke();
        }
        ctx.strokeStyle = textColor; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(padding, h - padding); ctx.lineTo(w - padding, h - padding); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(padding, h - padding); ctx.lineTo(padding, padding); ctx.stroke();
        
        ctx.fillStyle = textColor;
        drawArrow(w - padding, h - padding, 0);
        drawArrow(padding, padding, -Math.PI / 2);

    ctx.font = 'normal 12px Poppins';
        ctx.textAlign = 'center'; ctx.textBaseline = 'top';
        for (let i = 1; i <= 5; i++) ctx.fillText(formatNumber(i * xMax / 5), toX(i * xMax / 5), h - padding + 8);
        ctx.fillText("Fiyat ArtÄ±ÅŸ SayÄ±sÄ± (x)", w / 2, h - padding + 30);
        ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
        for (let i = 1; i <= 5; i++) ctx.fillText(Math.round(i * yMax / 5), padding - 8, toY(i * yMax / 5));
        ctx.textAlign = 'right'; ctx.textBaseline = 'top';
        ctx.fillText("O", padding - 5, h-padding + 5);
        ctx.save(); ctx.translate(padding - 45, h / 2); ctx.rotate(-Math.PI / 2); ctx.textAlign = 'center'; ctx.fillText("Gelir (TL)", 0, 0); ctx.restore();

        ctx.beginPath(); ctx.strokeStyle = headerColor; ctx.lineWidth = 3;
        for (let x = 0; x <= xMax; x += xMax / 200) {
            const y = G(x);
            if (y < 0) break; // x ekseninin altÄ±na inmeyelim
            if (x === 0) ctx.moveTo(toX(x), toY(y)); else ctx.lineTo(toX(x), toY(y));
        }
        ctx.stroke();

        if (vertexY >= 0 && vertexX >= 0 && vertexX <= xMax) {
            ctx.fillStyle = '#16a34a'; ctx.beginPath(); ctx.arc(toX(vertexX), toY(vertexY), 6, 0, 2*Math.PI); ctx.fill();
        }
        const currentY = G(currentX);
        if(currentY >= 0) {
           ctx.fillStyle = textColor; ctx.beginPath(); ctx.arc(toX(currentX), toY(currentY), 6, 0, 2*Math.PI); ctx.fill();
        }
    }
    
    // --- EXAM (Tiyatro Problemi - DEÄÄ°ÅÄ°KLÄ°K YOK) ---
    async function checkAndFinish() {
        if (examSubmitted) { showPage('page-evaluation'); return; }
        const finishBtn = document.getElementById('finish-exam-btn');
        if (finishBtn) finishBtn.disabled = true;
        document.querySelectorAll('#page-exam input, #page-exam textarea').forEach(field => field.disabled = true);
        examSubmitted = true;
        try { localStorage.setItem('examSubmitted', 'true'); } catch {}
        if (finishBtn) finishBtn.textContent = 'SonuÃ§larÄ± GÃ¶r';
        showPage('page-evaluation');
        const subtitleEl = document.getElementById('evaluation-subtitle');
        if (subtitleEl) subtitleEl.textContent = 'YanÄ±tlarÄ±nÄ±z yapay zeka tarafÄ±ndan analiz ediliyor.';
        const evalContent = document.getElementById('evaluationContent');
        if (evalContent) evalContent.innerHTML = '<div style="text-align: center; padding: 40px 0;"><div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: var(--header-color);"></div><h4 style="margin-top: 20px;">DeÄŸerlendirme SÃ¼rÃ¼yor...</h4></div>';
        const solutionsBtn = document.getElementById('viewSolutionsBtn');
        if (solutionsBtn) solutionsBtn.style.display = 'none';
        let totalScore = 0;
        try {
            if (!navigator.onLine) throw new Error('Ä°nternet baÄŸlantÄ±sÄ± yok.');
            const userPayload = collectUserResponses();
            const prompt = buildAIScoringPrompt(userPayload);
            const result = await callGemini(prompt);
            const evaluation = formatAIScoringResponse(result);
            document.getElementById('evaluationContent').innerHTML = evaluation.html;
            totalScore = evaluation.score;
        } catch (err) {
            console.error("AI Evaluation Failed:", err);
            totalScore = runFallbackEvaluation(err);
        }
    updateAllScoreDisplays(totalScore);
    try { sendScoreToLMS(totalScore); } catch (error) { console.error("LMS'e puan gÃ¶nderilirken hata oluÅŸtu:", error); }
        populateSolutionModal();
        document.getElementById('viewSolutionsBtn').style.display = 'inline-block';
    }
    
    function cleanNumber(value) { return value.trim().replace(/\s/g, '').replace(',', '.'); }
    function cleanExpression(value) { return value.trim().replace(/\s/g, '').toLowerCase(); }

    function parseFlexibleNumber(input) {
        if (input == null) return NaN;
        let str = String(input).trim();
        if (!str) return NaN;
        str = str.replace(/[^0-9.,\/-]/g, '');
        if (!str) return NaN;
        if (str.includes('/')) {
            const [num, den] = str.split('/');
            const n = parseFlexibleNumber(num);
            const d = parseFlexibleNumber(den);
            if (!isFinite(n) || !isFinite(d) || d === 0) return NaN;
            return n / d;
        }
        const hasDot = str.includes('.');
        const hasComma = str.includes(',');
        if (hasDot && hasComma) {
            const lastDot = str.lastIndexOf('.');
            const lastComma = str.lastIndexOf(',');
            const decSep = lastComma > lastDot ? ',' : '.';
            const thouSep = decSep === ',' ? '.' : ',';
            str = str.split(thouSep).join('');
            if (decSep === ',') str = str.replace(',', '.');
        } else if (hasComma) {
            if (/[,]\d{1,2}$/.test(str)) {
                str = str.replace(',', '.');
            } else {
                str = str.split(',').join('');
            }
        } else if (hasDot) {
            if (/[.]\d{1,2}$/.test(str)) {
            } else {
                str = str.split('.').join('');
            }
        }
        const val = parseFloat(str);
        return isFinite(val) ? val : NaN;
    }

    function parseLinearExpression(expr) {
        if (!expr) return { ok: false };
        let e = cleanExpression(String(expr));
        e = e.replace(/Â·|\*/g, '');
        e = e.replace(/^[a-z]\(x\)=/i, '');
        const xMatch = e.match(/([+-]?\d*(?:[.,]?\d+)?)x/);
        if (!xMatch) return { ok: false };
        let aStr = xMatch[1];
        if (aStr === '' || aStr === '+' || aStr === undefined) aStr = '1';
        if (aStr === '-') aStr = '-1';
        const a = parseFlexibleNumber(aStr);
        const rest = e.replace(xMatch[0], '');
        const tokens = rest.match(/[+-]?\d+(?:[.,]\d+)?/g) || [];
        const b = tokens.reduce((sum, t) => sum + (parseFlexibleNumber(t) || 0), 0);
        return { ok: isFinite(a) && isFinite(b), a, b };
    }

    function roughlyEqual(n1, n2, eps = 1e-2) {
        const a = parseFloat(n1), b = parseFloat(n2);
        if (!isFinite(a) || !isFinite(b)) return false;
        return Math.abs(a - b) <= eps;
    }
    
    function runFallbackEvaluation(error) {
        document.getElementById('evaluation-subtitle').textContent = "Standart DeÄŸerlendirme SonuÃ§larÄ±";
        const user = collectUserResponses();
        const correct = {
            f: { a: 10, b: 80 },
            s: { a: -20, b: 300 },
            a: -200, b: 1400, c: 24000,
            x: 3.5, price: 115, revenue: 26450
        };
        let totalScore = 0;
        let feedbackHTML = `<div style="padding:15px; background:var(--incorrect-bg); color:var(--incorrect-text); border:1px solid var(--incorrect-border); border-radius:8px; text-align:center; margin-bottom:20px;"><strong>YZ DeÄŸerlendirmesi BaÅŸarÄ±sÄ±z:</strong> ${error.message}. Standart puanlama devreye girdi.</div>`;
    const parsedF = parseLinearExpression(user['Soru-1'].fiyat);
    const q1_f = (parsedF.ok && roughlyEqual(parsedF.a, correct.f.a) && roughlyEqual(parsedF.b, correct.f.b)) ? 3 : 0;
    const parsedS = parseLinearExpression(user['Soru-1'].satis);
    const q1_s = (parsedS.ok && roughlyEqual(parsedS.a, correct.s.a) && roughlyEqual(parsedS.b, correct.s.b)) ? 2 : 0;
        const q1_total = q1_f + q1_s;
    const q2_a = roughlyEqual(parseFlexibleNumber(user['Soru-2'].a), correct.a) ? 2 : 0;
    const q2_b = roughlyEqual(parseFlexibleNumber(user['Soru-2'].b), correct.b) ? 2 : 0;
    const q2_c = roughlyEqual(parseFlexibleNumber(user['Soru-2'].c), correct.c) ? 1 : 0;
        const q2_total = q2_a + q2_b + q2_c;
    const q3_val = parseFlexibleNumber(user['Soru-3'].x);
    const q3_total = roughlyEqual(q3_val, correct.x) ? 5 : 0;
    const q4_val = parseFlexibleNumber(user['Soru-4'].fiyat);
    const q4_total = roughlyEqual(q4_val, correct.price, 0.5) ? 5 : 0;
    const q5_val = parseFlexibleNumber(user['Soru-5'].gelir);
    const q5_total = roughlyEqual(q5_val, correct.revenue, 0.5) ? 5 : 0;

        feedbackHTML += createEvalCard(
            'Soru 1: Fonksiyonlar', q1_total, 5,
            `DoÄŸru: F(x)=80 + 10x, S(x)=300 - 20x`,
            [ {label:'F(x)', score:q1_f, max:3}, {label:'S(x)', score:q1_s, max:2} ]
        );
        feedbackHTML += createEvalCard(
            'Soru 2: Gelir Denklemi', q2_total, 5,
            `DoÄŸru: a=-200, b=1400, c=24000`,
            [ {label:'a', score:q2_a, max:2}, {label:'b', score:q2_b, max:2}, {label:'c', score:q2_c, max:1} ]
        );
        feedbackHTML += createEvalCard('Soru 3: En Uygun \'x\'', q3_total, 5, `DoÄŸru: x = 3,5`);
        feedbackHTML += createEvalCard('Soru 4: En Uygun Fiyat', q4_total, 5, `DoÄŸru: Fiyat=115 TL`);
        feedbackHTML += createEvalCard('Soru 5: Maksimum Gelir', q5_total, 5, `DoÄŸru: Gelir=26450 TL`);

        totalScore = q1_total + q2_total + q3_total + q4_total + q5_total;
        document.getElementById('evaluationContent').innerHTML = feedbackHTML;
        return totalScore;
    }
    
    function createEvalCard(title, score, max, body, breakdown) {
        const s = Math.max(0, parseInt(score || 0));
        const m = Math.max(0, parseInt(max || 0));
        const perc = m > 0 ? (s/m)*100 : 0;
        const color = perc >= 99 ? '#22c55e' : (perc >= 50 ? '#f59e0b' : '#ef4444');
        const bodyText = body ? localizeDecimalDots(body) : '';
        const bodySection = bodyText ? `<div class="evaluation-body">${bodyText}</div>` : '';
        let breakdownHtml = '';
        if (Array.isArray(breakdown) && breakdown.length > 0) {
            const items = breakdown.map(b => `<li><strong>${b.label}:</strong> ${parseInt(b.score||0)} / ${parseInt(b.max||0)} puan</li>`).join('');
            breakdownHtml = `<ul style="margin:8px 0 0 16px;">${items}</ul>`;
        }
        return `<div class="evaluation-card" style="border-left-color: ${color};"><div class="evaluation-header"><h4>${title}</h4><div class="evaluation-score">${s} / ${m} Puan</div></div>${bodySection}${breakdownHtml}</div>`;
    }

    function updateAllScoreDisplays(finalScore) {
        const roundedScore = Math.round(finalScore);
        const scorePercentage = (roundedScore / 25) * 100;
        document.getElementById('finalScore').textContent = `${roundedScore} / 25`;
        document.getElementById('finalPercentage').textContent = `${scorePercentage.toFixed(0)}%`;
        const scoreCard = document.getElementById('scoreCard');
        if (scorePercentage >= 80) scoreCard.style.background = 'linear-gradient(135deg, #16a34a, #22c55e)';
        else if (scorePercentage >= 50) scoreCard.style.background = 'linear-gradient(135deg, #f59e0b, #facc15)';
        else scoreCard.style.background = 'linear-gradient(135deg, #dc2626, #ef4444)';
    }

    function collectUserResponses(){
        return {
            'Soru-1': { fiyat: document.getElementById('p2_q1_price').value, satis: document.getElementById('p2_q1_sales').value },
            'Soru-2': { a: document.getElementById('p2_q2_a').value, b: document.getElementById('p2_q2_b').value, c: document.getElementById('p2_q2_c').value },
            'Soru-3': { x: document.getElementById('p2_q3_x').value },
            'Soru-4': { fiyat: document.getElementById('p2_q4_price').value },
            'Soru-5': { gelir: document.getElementById('p2_q5_revenue').value }
        };
    }

        function buildAIScoringPrompt(data){
                return `YALNIZCA JSON FORMATINDA CEVAP VER. TÃœM Ã‡IKTI TÃœRKÃ‡E OLSUN. GENEL YORUM EKLEME.

UZMAN DEÄERLENDÄ°RME: Kendini uzman bir matematik Ã¶ÄŸretmeni gibi konumlandÄ±r. AÃ§Ä±klamalarÄ± kÄ±sa, isabetli ve pedagojik tut. Hata analizi yap.

PUANLAMA KURALLARI:
- TÃ¼m puanlar TAM SAYI olmalÄ±dÄ±r (ondalÄ±k YOK).
- Her Ã§ok alanlÄ± soru iÃ§in alan bazlÄ± puan daÄŸÄ±lÄ±mÄ±nÄ± belirt (Ã¶r. q1.alanlar, q2.alanlar).
- Gerekli gÃ¶rdÃ¼ÄŸÃ¼n yerde, Ã§Ã¶zÃ¼m AÅAMALARI iÃ§in PARÃ‡ALI puanlama yapabilirsin. Bunun iÃ§in opsiyonel "adÄ±mlar" alanÄ±nÄ± kullan (her adÄ±m: {"ad": string, "puan": int}).
- HATA TAÅIMA: Ä°lk sorularda yapÄ±lan bir hata sonraki cevaplarÄ± etkiliyorsa, yÃ¶ntemin doÄŸruluÄŸunu dikkate alarak uygun KISMÄ° puan ver (Ã¶rn. yanlÄ±ÅŸ deÄŸeri doÄŸru yÃ¶ntemle kullanmÄ±ÅŸsa puan kÄ±r ama tamamÄ±nÄ± sÄ±fÄ±rlama).
- AÃ§Ä±klamalarda ondalÄ±k gerekiyorsa nokta yerine virgÃ¼l kullan (3,5 gibi).

DOÄRU CEVAPLAR VE PUANLAMA (TOPLAM 25 PUAN):
1. (5 puan) Fonksiyonlar: F(x)=80+10x (3p), S(x)=300-20x (2p)
2. (5 puan) Gelir Denklemi: a=-200 (2p), b=1400 (2p), c=24000 (1p)
3. (5 puan) En Uygun x: 3,5
4. (5 puan) En Uygun Fiyat: 115 TL
5. (5 puan) Maksimum Gelir: 26450 TL

Ã–ÄRENCÄ°NÄ°N YANITLARI: ${JSON.stringify(data)}

JSON ÅEMASI (anahtarlarÄ± TÃœRKÃ‡E kullan):
{
    "q1": {"puan": 0-5, "aÃ§Ä±klama": "...", "alanlar": {"fiyat": 0-3, "satis": 0-2}, "adÄ±mlar": [{"ad": "...", "puan": 0-3}]},
    "q2": {"puan": 0-5, "aÃ§Ä±klama": "...", "alanlar": {"a": 0-2, "b": 0-2, "c": 0-1}, "adÄ±mlar": [{"ad": "...", "puan": 0-3}]},
    "q3": {"puan": 0-5, "aÃ§Ä±klama": "...", "adÄ±mlar": [{"ad": "...", "puan": 0-5}]},
    "q4": {"puan": 0-5, "aÃ§Ä±klama": "...", "adÄ±mlar": [{"ad": "...", "puan": 0-5}]},
    "q5": {"puan": 0-5, "aÃ§Ä±klama": "...", "adÄ±mlar": [{"ad": "...", "puan": 0-5}]}
}`;
        }

    async function callGemini(prompt) {
        const apiKey = "AIzaSyCEhU3erLOAJB9cADTqaGanVidc2DRbhr8";
        const model = 'gemini-2.0-flash';
        const url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${apiKey}`;
        const body = { contents: [{ parts: [{ text: prompt }] }] };
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000);
        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body), signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) {
            let errorText = '';
            try { errorText = await response.text(); } catch (_) {}
            throw new Error(`API HatasÄ±: ${response.status} ${errorText}`.trim());
        }
        const json = await response.json();
        const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("API'den boÅŸ yanÄ±t alÄ±ndÄ±.");
        return text;
    }

    function formatAIScoringResponse(raw) {
        let parsed;
        let totalScore = 0;
        try { 
            parsed = JSON.parse(raw.trim().replace(/^```json\s*|```\s*$/g, ''));
        } catch (e) { throw new Error("YZ yanÄ±tÄ± JSON formatÄ±nda deÄŸil."); }
        
        const questions = [
            { id: 'q1', title: 'Soru 1: Fonksiyon Modelleme', max: 5 }, 
            { id: 'q2', title: 'Soru 2: Gelir Fonksiyonu', max: 5 },
            { id: 'q3', title: 'Soru 3: Optimum DeÄŸiÅŸken DeÄŸeri', max: 5 }, 
            { id: 'q4', title: 'Soru 4: En Uygun Bilet FiyatÄ±', max: 5 },
            { id: 'q5', title: 'Soru 5: Maksimum Gelir', max: 5 }
        ];
        
        let html = '';
        questions.forEach(q => {
            const data = parsed[q.id];
            if (data) {
                const score = parseInt(data.puan || 0) || 0;
                totalScore += score;
                const aciklama = (data['aÃ§Ä±klama'] || data['aciklama'] || '').toString();
                let breakdown = undefined;
                if (data.alanlar && typeof data.alanlar === 'object') {
                    if (q.id === 'q1') {
                        breakdown = [
                            { label: 'F(x)', score: parseInt(data.alanlar.fiyat || 0) || 0, max: 3 },
                            { label: 'S(x)', score: parseInt(data.alanlar.satis || 0) || 0, max: 2 }
                        ];
                    } else if (q.id === 'q2') {
                        breakdown = [
                            { label: 'a', score: parseInt(data.alanlar.a || 0) || 0, max: 2 },
                            { label: 'b', score: parseInt(data.alanlar.b || 0) || 0, max: 2 },
                            { label: 'c', score: parseInt(data.alanlar.c || 0) || 0, max: 1 }
                        ];
                    }
                }
                html += createEvalCard(q.title, score, q.max, aciklama, breakdown);
            }
        });
        
        return { html, score: totalScore };
    }


    function populateSolutionModal() {
        document.getElementById('solutionContent').innerHTML = `
            <div class="answer-block"><h4>Soru 1: Fonksiyon Modelleme (5 Puan)</h4><p>\\[F(x) = 80 + 10x\\]\\[S(x) = 300 - 20x\\]</p></div>
            <div class="answer-block"><h4>Soru 2: Gelir Fonksiyonu (5 Puan)</h4><p>\\[G(x) = (80 + 10x)(300 - 20x)\\] <br>\\[= -200x^2 + 1400x + 24000\\]</p></div>
            <div class="answer-block"><h4>Soru 3: Optimum DeÄŸiÅŸken DeÄŸeri (5 Puan)</h4>
            <p>Gelir fonksiyonu G(x)'i tam kareye tamamlama yÃ¶ntemiyle maksimum deÄŸerini bulalÄ±m:<br>
            \\[G(x) = -200x^2 + 1400x + 24000\\]
            \\[G(x) = -200(x^2 - 7x) + 24000\\]
            \\[G(x) = -200(x^2 - 7x + 12,25 - 12,25) + 24000\\]
            \\[G(x) = -200((x - 3,5)^2 - 12,25) + 24000\\]
            \\[G(x) = -200(x - 3,5)^2 + 2450 + 24000\\]
            \\[G(x) = -200(x - 3,5)^2 + 26450\\]
            Bu ifadenin maksimum olmasÄ± iÃ§in \\((x - 3,5)^2\\) teriminin en kÃ¼Ã§Ã¼k deÄŸeri olan 0'a eÅŸit olmasÄ± gerekir. Bu durumda \\(x = 3,5\\) olur.</p></div>
            <div class="answer-block"><h4>Soru 4: En Uygun Bilet FiyatÄ± (5 Puan)</h4><p>En uygun fiyat, x=3,5 deÄŸeri F(x) fonksiyonunda yerine yazÄ±larak bulunur: <br> \\(F(3,5) = 80 + 10(3,5) = 115\\) TL</p></div>
            <div class="answer-block"><h4>Soru 5: Maksimum Gelir (5 Puan)</h4><p>x = 3,5 iÃ§in G(x) fonksiyonunun aldÄ±ÄŸÄ± maksimum deÄŸer, tam kareye tamamlanmÄ±ÅŸ ifadedeki sabit terim olan 26450 TL'dir.</p></div>
            `;
        MathJax.typesetPromise();
    }
    
    const modal = document.getElementById('solution-modal');
    function openSolutionsModal() { modal.style.display = "block"; }
    function closeSolutionsModal() { modal.style.display = "none"; }
    window.onclick = function(event) { if (event.target == modal) modal.style.display = "none"; }
</script>
</body>
</html>